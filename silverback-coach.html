<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Silverback Coach Calculator</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 24px;
    }

    .layout {
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 0.9fr 1.1fr;
      gap: 24px;
    }

    .panel {
      background: #020617;
      border-radius: 16px;
      padding: 18px 20px 22px;
      border: 1px solid #1f2937;
      box-shadow: 0 18px 40px rgba(0,0,0,0.6);
    }

    .panel-header {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .subtle {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
    }

    .form-row {
      display: flex;
      flex-direction: column;
    }

    label {
      font-size: 12px;
      margin-bottom: 3px;
      color: #cbd5f5;
    }

    input,
    select {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      height: 34px;
      box-sizing: border-box;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px #38bdf8;
    }

    .button-row {
      margin-top: 14px;
    }

    button {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #38bdf8;
      color: #020617;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      height: 34px;
      box-sizing: border-box;
    }

    button:hover {
      background: #0ea5e9;
    }

    .calc-strip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      background: #020617;
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid #1f2937;
      font-size: 12px;
      min-width: 110px;
      text-align: center;
    }

    .pill-strong {
      background: #0369a1;
      border-color: #0ea5e9;
      color: #e5e7eb;
      font-weight: 600;
    }

    .big-kcal {
      font-size: 30px;
      font-weight: 700;
      margin-top: 6px;
    }

    .big-kcal-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #9ca3af;
    }

    .centered {
      text-align: center;
    }

    .adjust-row {
      display: flex;
      align-items: flex-end;
      gap: 16px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .adjust-input {
      max-width: 200px;
    }

    .adjust-control {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .adjust-btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 13px;
      width: 30px;
      text-align: center;
      height: 34px;
      box-sizing: border-box;
    }

    .adjust-btn:hover {
      background: #111827;
    }

    .adjust-control input {
      width: 80px;
      text-align: center;
    }

    .adjust-summary {
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.4;
    }

    .adjust-dbw-label {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 2px;
    }

    .adjust-dbw-value {
      font-size: 13px;
      color: #e5e7eb;
      font-weight: 600;
    }

    .macro-bar {
      margin-top: 14px;
      padding: 10px 10px 12px;
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      position: relative;
      overflow: hidden;
    }

    .macro-bar-track {
      position: relative;
      height: 18px;
      border-radius: 999px;
      overflow: hidden;
      display: flex;
    }

    .macro-segment {
      height: 100%;
    }

    .macro-carbs {
      background: #0284c7;
    }

    .macro-protein {
      background: #0f172a;
    }

    .macro-fat {
      background: #f97316;
    }

    .handle {
      position: absolute;
      top: 50%;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }

    .macro-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 11px;
    }

    .macro-col {
      text-align: left;
    }

    .macro-name {
      font-weight: 600;
    }

    .macro-line {
      color: #9ca3af;
    }

    .note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .timing-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 11px;
    }

    .timing-table th,
    .timing-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
    }

    .timing-table th {
      text-align: left;
      font-weight: 600;
      color: #cbd5f5;
      font-size: 11px;
    }

    .timing-phase {
      color: #e5e7eb;
      font-weight: 500;
    }

    .timing-small {
      color: #9ca3af;
      font-size: 10px;
    }

    .right-col {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .planner-wrapper {
      max-width: 1100px;
      margin: 18px auto 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .planner-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 11px;
    }

    .planner-table th,
    .planner-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
    }

    .planner-table th {
      text-align: left;
      font-weight: 600;
      color: #cbd5f5;
    }

    .tag-pill {
      display: inline-block;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 999px;
      background: #0369a1;
      color: #e5e7eb;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .planner-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px 14px;
      margin-bottom: 10px;
    }

    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .planner-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .footer {
      max-width: 1100px;
      margin: 18px auto 0;
      font-size: 10px;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- LEFT: INPUTS -->
    <div class="panel">
      <div class="panel-header">Client inputs</div>
      <div class="subtle">Coach-facing setup for RMR, PAL, training and manual calorie adjustment.</div>

      <div class="form-grid">
        <div class="form-row">
          <label for="sex">Gender</label>
          <select id="sex">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="form-row">
          <label for="age">Age (years)</label>
          <input id="age" type="number" value="30">
        </div>
        <div class="form-row">
          <label for="weight">Weight (kg)</label>
          <input id="weight" type="number" value="80">
        </div>
        <div class="form-row">
          <label for="height">Height (cm)</label>
          <input id="height" type="number" value="180">
        </div>

        <div class="form-row">
          <label for="pal">PAL (activity factor)</label>
          <select id="pal">
            <option value="1.2">1.2 · Sedentary · &lt;5k steps/day</option>
            <option value="1.35">1.35 · Low active · 5–7.9k steps/day</option>
            <option value="1.5" selected>1.5 · Moderate · 8–9.9k steps/day</option>
            <option value="1.7">1.7 · Very active · 10–14.9k steps/day</option>
            <option value="1.9">1.9 · Ultra active · ≥15k steps/day</option>
          </select>
        </div>

        <div class="form-row">
          <label for="sessions">Training sessions per week</label>
          <input id="sessions" type="number" value="0">
        </div>

        <div class="form-row">
          <label for="duration">Average session duration (min)</label>
          <input id="duration" type="number" value="60">
        </div>

        <div class="form-row">
          <label for="intensity">Training intensity</label>
          <select id="intensity">
            <option value="light">Light</option>
            <option value="moderate" selected>Moderate</option>
            <option value="hard">Hard</option>
          </select>
        </div>
      </div>

      <div class="adjust-row">
        <div class="form-row adjust-input">
          <label>Daily kcal adjustment</label>
          <div class="adjust-control">
            <button class="adjust-btn" onclick="changeAdj(-100)">−</button>
            <input id="kcalAdj" type="number" value="0">
            <button class="adjust-btn" onclick="changeAdj(100)">+</button>
          </div>
          <div class="adjust-summary">
            Negative = loss, positive = gain.<br>
            100 kcal/day ≈ 0.09 kg/week.
          </div>
        </div>
        <div>
          <div class="adjust-dbw-label">Estimated change:</div>
          <div class="adjust-dbw-value" id="adjustDbw">0.00 kg/week (maintain)</div>
        </div>
      </div>

      <div class="button-row">
        <button onclick="recalc()">Update calculations</button>
      </div>
    </div>

    <!-- RIGHT: TARGET + PERI -->
    <div class="right-col">
      <div class="panel">
        <div class="panel-header">Silverback target</div>
        <div class="subtle">Target energy and macro breakdown for current setup.</div>

        <div class="centered">
          <div class="big-kcal" id="targetKcal">–</div>
          <div class="big-kcal-label">Target kcal / day</div>
        </div>

        <div class="calc-strip">
          <div class="pill" id="pillRmr">RMR –</div>
          <div class="pill" id="pillPal">× PAL –</div>
          <div class="pill" id="pillTrain">+ Training –</div>
          <div class="pill" id="pillAdj">± 0 kcal</div>
          <div class="pill pill-strong" id="pillTdee">= – kcal</div>
        </div>

        <div style="margin-top:16px; font-size:12px; font-weight:600;">Macro split</div>
        <div class="note">Drag handles to adjust 35% carbs · 35% protein · 30% fat (must sum to 100%).</div>

        <div class="macro-bar" id="macroBar">
          <div class="macro-bar-track" id="macroTrack">
            <div class="macro-segment macro-carbs" id="segCarbs"></div>
            <div class="macro-segment macro-protein" id="segProtein"></div>
            <div class="macro-segment macro-fat" id="segFat"></div>
          </div>
          <div class="handle" id="handleLeft"></div>
          <div class="handle" id="handleRight"></div>
        </div>

        <div class="macro-labels">
          <div class="macro-col">
            <div class="macro-name">Carbs</div>
            <div class="macro-line" id="carbLine">–</div>
          </div>
          <div class="macro-col">
            <div class="macro-name">Protein</div>
            <div class="macro-line" id="protLine">–</div>
          </div>
          <div class="macro-col">
            <div class="macro-name">Fat</div>
            <div class="macro-line" id="fatLine">–</div>
          </div>
        </div>

        <div class="note">
          Lines show % of kcal, grams/day and g/kg (based on current bodyweight).
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">Peri‑workout nutrient timing</div>
        <div class="subtle">Coach-facing guide based on bodyweight and today’s carb target.[web:69][web:73]</div>

        <table class="timing-table">
          <thead>
            <tr>
              <th>Phase</th>
              <th>Protein</th>
              <th>Carbs</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="timing-phase">3–4 h pre</td>
              <td id="tProtPreShort">–</td>
              <td id="tCarbPreShort">–</td>
            </tr>
            <tr>
              <td class="timing-phase">&lt;2 h pre</td>
              <td id="tProtPreLong">–</td>
              <td id="tCarbPreLong">–</td>
            </tr>
            <tr>
              <td class="timing-phase">Intra</td>
              <td id="tProtIntra">–</td>
              <td id="tCarbIntra">–</td>
            </tr>
            <tr>
              <td class="timing-phase">Post</td>
              <td id="tProtPost">–</td>
              <td id="tCarbPost">–</td>
            </tr>
          </tbody>
        </table>
        <div class="timing-small">
          Protein: 0.4 g/kg main pre, ≈10 g top‑up pre, 15–20 g EAAs intra, 0.6–0.8 g/kg post. Carbs: see g/kg and % of daily carb options in each row.[web:69][web:216][web:239]
        </div>
      </div>
    </div>
  </div>

  <!-- Planner panels -->
  <div class="planner-wrapper">
    <div class="panel">
      <div class="panel-header">Training day meal timing</div>
      <div class="subtle">
        First feeding within 1 h of waking, last 2–3 h before bed, mostly 3–5 h gaps, ≥4 protein feedings. Intra carbs sit at training time.[web:196][web:234]
      </div>

      <div class="planner-grid">
        <div class="form-row">
          <label for="tdWake">Wake time</label>
          <input id="tdWake" type="time" value="07:00">
        </div>
        <div class="form-row">
          <label for="tdBed">Bed time</label>
          <input id="tdBed" type="time" value="23:00">
        </div>
        <div class="form-row">
          <label for="tdTrain">Training start</label>
          <input id="tdTrain" type="time" value="18:00">
        </div>
        <div class="form-row">
          <label for="tdMeals">Meals per day</label>
          <select id="tdMeals">
            <option value="4" selected>4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>

      <table class="planner-table">
        <thead>
          <tr>
            <th>Meal</th>
            <th>Time</th>
            <th>Tag</th>
            <th>Protein (g)</th>
            <th>Carbs (g)</th>
            <th>Fat (g)</th>
          </tr>
        </thead>
        <tbody id="tdMealBody"></tbody>
        <tfoot>
          <tr>
            <td colspan="6" class="timing-small">
              Intra training: typically 15–20 g EAAs and ~0.5 g/kg carbs, matching the peri‑workout card.[web:232][web:235]
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="panel">
      <div class="panel-header">Rest day meal timing</div>
      <div class="subtle">
        Same wake/bed and spacing rules, no pre/intra/post tags. Coaches can mirror training‑day macros or use lower‑kcal rest‑day targets.[web:196]
      </div>

      <div class="planner-grid">
        <div class="form-row">
          <label for="rdWake">Wake time</label>
          <input id="rdWake" type="time" value="07:00">
        </div>
        <div class="form-row">
          <label for="rdBed">Bed time</label>
          <input id="rdBed" type="time" value="23:00">
        </div>
        <div class="form-row">
          <label for="rdMeals">Meals per day</label>
          <select id="rdMeals">
            <option value="4" selected>4</option>
            <option value="5">5</option>
          </select>
        </div>
      </div>

      <table class="planner-table">
        <thead>
          <tr>
            <th>Meal</th>
            <th>Time</th>
            <th>Protein (g)</th>
            <th>Carbs (g)</th>
            <th>Fat (g)</th>
          </tr>
        </thead>
        <tbody id="rdMealBody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    Licensed to Silverback Performance Coaching LLC by Archangel Project LLC.
  </div>

  <script>
    function calcRmr(sex, weight, height, age) {
      if (sex === 'male') {
        return 10 * weight + 6.25 * height - 5 * age + 5;
      } else {
        return 10 * weight + 6.25 * height - 5 * age - 161;
      }
    }

    function kcalPerHourForIntensity(intensity) {
      if (intensity === 'light') return 250;
      if (intensity === 'moderate') return 400;
      return 550;
    }

    function changeAdj(delta) {
      const input = document.getElementById('kcalAdj');
      const current = Number(input.value || 0);
      input.value = current + delta;
      recalc();
    }

    let carbPct = 35;
    let protPct = 35;
    let fatPct  = 30;

    function recalc() {
      const sex = document.getElementById('sex').value;
      const age = Number(document.getElementById('age').value);
      const weight = Number(document.getElementById('weight').value);
      const height = Number(document.getElementById('height').value);
      const pal = Number(document.getElementById('pal').value);
      const sessions = Number(document.getElementById('sessions').value || 0);
      const duration = Number(document.getElementById('duration').value || 0);
      const intensity = document.getElementById('intensity').value;
      const kcalAdj = Number(document.getElementById('kcalAdj').value || 0);

      const rmr = calcRmr(sex, weight, height, age);
      const base = rmr * pal;

      const activeMinutes = duration * 0.6;
      const kcalPerHour = kcalPerHourForIntensity(intensity);
      const kcalPerSession = (activeMinutes / 60) * kcalPerHour;
      const trainingKcalPerDay = (sessions * kcalPerSession) / 7;

      const tdee = base + trainingKcalPerDay;
      const target = tdee + kcalAdj;
      const weeklyKg = kcalAdj * 0.0009;

      document.getElementById('targetKcal').innerText = Math.round(target);
      document.getElementById('pillRmr').innerText = 'RMR ' + Math.round(rmr);
      document.getElementById('pillPal').innerText = '× PAL ' + pal.toFixed(2);
      document.getElementById('pillTrain').innerText = '+ Training ' + Math.round(trainingKcalPerDay);
      document.getElementById('pillAdj').innerText =
        (kcalAdj >= 0 ? '+ ' : '− ') + Math.abs(kcalAdj) + ' kcal';
      document.getElementById('pillTdee').innerText = '= ' + Math.round(target) + ' kcal';

      const sign = kcalAdj === 0 ? 'maintain' : (kcalAdj < 0 ? 'loss' : 'gain');
      document.getElementById('adjustDbw').innerText =
        weeklyKg.toFixed(2) + ' kg/week (' + sign + ')';

      updateMacroBar();
      updateMacroLines(target, weight);
      updatePeriWorkoutTiming(weight);
      recalcTrainingDayMeals(weight, target);
      recalcRestDayMeals(weight, target);
    }

    function updateMacroBar() {
      const track = document.getElementById('macroTrack');
      const width = track.clientWidth;

      const carbW = width * (carbPct / 100);
      const protW = width * (protPct / 100);
      const fatW  = width * (fatPct  / 100);

      document.getElementById('segCarbs').style.width = carbW + 'px';
      document.getElementById('segProtein').style.width = protW + 'px';
      document.getElementById('segFat').style.width = fatW + 'px';

      document.getElementById('handleLeft').style.left = carbW + 'px';
      document.getElementById('handleRight').style.left = (carbW + protW) + 'px';
    }

    function updateMacroLines(targetKcal, weight) {
      const totalKcal = Math.max(targetKcal, 1);

      const carbKcal = totalKcal * (carbPct / 100);
      const protKcal = totalKcal * (protPct / 100);
      const fatKcal  = totalKcal * (fatPct  / 100);

      const carbG = carbKcal / 4;
      const protG = protKcal / 4;
      const fatG  = fatKcal  / 9;

      const w = Math.max(weight, 1);

      document.getElementById('carbLine').innerText =
        carbPct.toFixed(0) + '% · ' + Math.round(carbG) + ' g (' +
        (carbG / w).toFixed(2) + ' g/kg)';

      document.getElementById('protLine').innerText =
        protPct.toFixed(0) + '% · ' + Math.round(protG) + ' g (' +
        (protG / w).toFixed(2) + ' g/kg)';

      document.getElementById('fatLine').innerText =
        fatPct.toFixed(0) + '% · ' + Math.round(fatG) + ' g (' +
        (fatG / w).toFixed(2) + ' g/kg)';
    }

    // Peri‑workout logic with your exact rules
    function updatePeriWorkoutTiming(weight) {
      const w = Math.max(weight, 1);

      // --- PROTEIN ---

      const preProtG = 0.4 * w;
      const postProtMin = 0.6 * w;
      const postProtMax = 0.8 * w;

      // 3–4 h pre
      document.getElementById('tProtPreShort').innerHTML =
        Math.round(preProtG) + ' g<br><span class="timing-small">0.40 g/kg</span>';

      // <2 h pre – minimal protein
      document.getElementById('tProtPreLong').innerHTML =
        '≈10 g<br><span class="timing-small">Minimal protein (small feeding)</span>';

      // Intra – EAAs
      document.getElementById('tProtIntra').innerHTML =
        '15–20 g<br><span class="timing-small">EAAs during training</span>';

      // Post
      document.getElementById('tProtPost').innerHTML =
        Math.round(postProtMin) + '–' + Math.round(postProtMax) +
        ' g<br><span class="timing-small">0.60–0.80 g/kg</span>';

      // --- CARBS (needs today’s total carbs) ---
      const targetKcalText = document.getElementById('targetKcal').innerText || '0';
      const targetKcal = Number(targetKcalText.replace(/[^0-9.]/g, '')) || 0;
      const totalKcal = Math.max(targetKcal, 1);
      const carbKcal = totalKcal * (carbPct / 100);
      const totalCarbG = carbKcal / 4;
      const fifteenPctCarbs = 0.15 * totalCarbG;
      const thirtyPctCarbs  = 0.30 * totalCarbG;

      // 3–4 h pre
      const preShort08 = 0.8 * w;
      const preShort10 = 1.0 * w;
      document.getElementById('tCarbPreShort').innerHTML =
        Math.round(Math.min(preShort08, preShort10, fifteenPctCarbs)) + '–' +
        Math.round(Math.max(preShort08, preShort10, fifteenPctCarbs)) + ' g' +
        '<br><span class="timing-small">0.8 g/kg, 1.0 g/kg or ≈15% of daily carbs (≈' +
        Math.round(fifteenPctCarbs) + ' g)</span>';

      // <2 h pre
      const preLong05 = 0.5 * w;
      const preLong08 = 0.8 * w;
      const preLong10 = 1.0 * w;
      document.getElementById('tCarbPreLong').innerHTML =
        Math.round(Math.min(preLong05, preLong08, preLong10, fifteenPctCarbs)) + '–' +
        Math.round(Math.max(preLong05, preLong08, preLong10, fifteenPctCarbs)) + ' g' +
        '<br><span class="timing-small">0.5, 0.8, 1.0 g/kg or ≈15% of daily carbs (≈' +
        Math.round(fifteenPctCarbs) + ' g)</span>';

      // Intra – baseline 0.5 g/kg
      const intra05 = 0.5 * w;
      document.getElementById('tCarbIntra').innerHTML =
        Math.round(intra05) + ' g<br><span class="timing-small">0.50 g/kg baseline during training</span>';

      // Post – 1.2, 1.5 g/kg or 30% carbs
      const post12 = 1.2 * w;
      const post15 = 1.5 * w;
      document.getElementById('tCarbPost').innerHTML =
        Math.round(Math.min(post12, post15, thirtyPctCarbs)) + '–' +
        Math.round(Math.max(post12, post15, thirtyPctCarbs)) + ' g' +
        '<br><span class="timing-small">1.2 g/kg, 1.5 g/kg or ≈30% of daily carbs (≈' +
        Math.round(thirtyPctCarbs) + ' g)</span>';
    }

    // Planner helpers
    function parseTimeToMinutes(t) {
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    }

    function minutesToTimeStr(mins) {
      mins = (mins + 1440) % 1440;
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return (h < 10 ? '0' + h : '' + h) + ':' + (m < 10 ? '0' + m : '' + m);
    }

    function buildMealTimes(wakeStr, bedStr, meals) {
      const wake = parseTimeToMinutes(wakeStr);
      const bed = parseTimeToMinutes(bedStr);
      let awakeSpan = bed - wake;
      if (awakeSpan <= 0) awakeSpan += 1440;
      const firstMeal = wake + 30;
      const lastMeal = bed - 150;
      if (lastMeal <= firstMeal) {
        const gap = awakeSpan / (meals - 1);
        const times = [];
        for (let i = 0; i < meals; i++) times.push(wake + i * gap);
        return times;
      }
      const span = lastMeal - firstMeal;
      const gap = span / (meals - 1);
      const times = [];
      for (let i = 0; i < meals; i++) times.push(firstMeal + i * gap);
      return times;
    }

    function macroPerMeal(targetKcal, meals) {
      const totalKcal = Math.max(targetKcal, 1);
      const carbKcal = totalKcal * (carbPct / 100);
      const protKcal = totalKcal * (protPct / 100);
      const fatKcal  = totalKcal * (fatPct  / 100);
      const carbG = carbKcal / 4;
      const protG = protKcal / 4;
      const fatG  = fatKcal  / 9;
      return {
        carbPer:  carbG / meals,
        protPer:  protG / meals,
        fatPer:   fatG  / meals
      };
    }

    function tagTrainingMeals(mealTimes, trainStr) {
      const trainMin = parseTimeToMinutes(trainStr);
      const tags = new Array(mealTimes.length).fill('');
      let preIdx = -1;
      for (let i = 0; i < mealTimes.length; i++) {
        if (mealTimes[i] < trainMin) preIdx = i;
      }
      if (preIdx === -1) preIdx = 0;
      let postIdx = -1;
      for (let i = 0; i < mealTimes.length; i++) {
        if (mealTimes[i] > trainMin) { postIdx = i; break; }
      }
      if (postIdx === -1) postIdx = mealTimes.length - 1;
      tags[preIdx] = 'Pre';
      tags[postIdx] = 'Post';
      return tags;
    }

    function recalcTrainingDayMeals(weight, targetKcal) {
      const wakeStr = document.getElementById('tdWake').value;
      const bedStr  = document.getElementById('tdBed').value;
      const trainStr = document.getElementById('tdTrain').value;
      const meals   = parseInt(document.getElementById('tdMeals').value || '4', 10);

      const times = buildMealTimes(wakeStr, bedStr, meals);
      const tags  = tagTrainingMeals(times, trainStr);
      const macros = macroPerMeal(targetKcal, meals);

      const tbody = document.getElementById('tdMealBody');
      tbody.innerHTML = '';

      for (let i = 0; i < meals; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>Meal ${i + 1}</td>
          <td>${minutesToTimeStr(times[i])}</td>
          <td>${tags[i] ? '<span class="tag-pill">' + tags[i] + '</span>' : ''}</td>
          <td>${Math.round(macros.protPer)}</td>
          <td>${Math.round(macros.carbPer)}</td>
          <td>${Math.round(macros.fatPer)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function recalcRestDayMeals(weight, targetKcal) {
      const wakeStr = document.getElementById('rdWake').value;
      const bedStr  = document.getElementById('rdBed').value;
      const meals   = parseInt(document.getElementById('rdMeals').value || '4', 10);

      const times = buildMealTimes(wakeStr, bedStr, meals);
      const macros = macroPerMeal(targetKcal, meals);

      const tbody = document.getElementById('rdMealBody');
      tbody.innerHTML = '';

      for (let i = 0; i < meals; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>Meal ${i + 1}</td>
          <td>${minutesToTimeStr(times[i])}</td>
          <td>${Math.round(macros.protPer)}</td>
          <td>${Math.round(macros.carbPer)}</td>
          <td>${Math.round(macros.fatPer)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function initHandles() {
      const track = document.getElementById('macroTrack');
      const handleLeft = document.getElementById('handleLeft');
      const handleRight = document.getElementById('handleRight');

      let dragging = null;

      function onMouseDown(e, which) {
        dragging = which;
        e.preventDefault();
      }

      function onMouseMove(e) {
        if (!dragging) return;
        const rect = track.getBoundingClientRect();
        let x = e.clientX - rect.left;
        if (x < 0) x = 0;
        if (x > rect.width) x = rect.width;

        const totalWidth = rect.width;

        if (dragging === 'left') {
          const rightPos = (carbPct + protPct) / 100 * totalWidth;
          if (x < 0) x = 0;
          if (x > rightPos - 20) x = rightPos - 20;
          const newCarbPct = (x / totalWidth) * 100;
          const totalCP = carbPct + protPct;
          const newProtPct = totalCP - newCarbPct;
          carbPct = Math.max(5, Math.min(90, newCarbPct));
          protPct = Math.max(5, Math.min(90, newProtPct));
        } else if (dragging === 'right') {
          const leftPos = (carbPct / 100) * totalWidth;
          if (x < leftPos + 20) x = leftPos + 20;
          if (x > totalWidth) x = totalWidth;
          const cpWidth = x - leftPos;
          const newProtPct = (cpWidth / totalWidth) * 100;
          const newFatPct = 100 - carbPct - newProtPct;
          protPct = Math.max(5, Math.min(90, newProtPct));
          fatPct = Math.max(5, Math.min(90, newFatPct));
        }

        const sum = carbPct + protPct + fatPct;
        if (sum !== 100) {
          const factor = 100 / sum;
          carbPct *= factor;
          protPct *= factor;
          fatPct  *= factor;
        }

        recalc();
      }

      function onMouseUp() {
        dragging = null;
      }

      handleLeft.addEventListener('mousedown', e => onMouseDown(e, 'left'));
      handleRight.addEventListener('mousedown', e => onMouseDown(e, 'right'));
      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);
    }

    function wireInputs() {
      const ids = [
        'sex','age','weight','height','pal','sessions','duration','intensity','kcalAdj',
        'tdWake','tdBed','tdTrain','tdMeals','rdWake','rdBed','rdMeals'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('input', recalc);
        el.addEventListener('change', recalc);
      });
    }

    window.addEventListener('load', () => {
      initHandles();
      wireInputs();
      recalc();
    });
  </script>
</body>
</html>
