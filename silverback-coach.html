<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Silverback Coach Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #0b0c10;
      color: #f5f5f5;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
      gap: 16px;
    }
    .card {
      background: #151821;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .card h2 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 0.75rem;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
      align-items: center;
    }
    label {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    input, select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #0f1118;
      color: #f5f5f5;
      font-size: 0.9rem;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
    .output-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 0.9rem;
    }
    .output-row span.value {
      font-weight: 600;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: #243447;
      color: #cdd9e5;
      margin-left: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }
    th, td {
      border-bottom: 1px solid #242938;
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      background: #1b1f2b;
    }
    .notice {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 6px;
    }
    .pill-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid #333;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .pill-toggle button {
      border: none;
      background: transparent;
      color: #cdd9e5;
      padding: 4px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .pill-toggle button.active {
      background: #f0b90b;
      color: #111;
      font-weight: 600;
    }
    .muted {
      opacity: 0.7;
      font-size: 0.8rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <h1>Silverback Coach Calculator</h1>

  <div class="layout">
    <!-- LEFT COLUMN: CORE CALCULATOR (existing stuff) -->
    <div>
      <div class="card">
        <h2>Client inputs</h2>
        <div class="grid-2">
          <label for="gender">Gender</label>
          <select id="gender">
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>

          <label for="age">Age (years)</label>
          <input id="age" type="number" value="30" min="16" max="80" />

          <label for="weight">Weight (kg)</label>
          <input id="weight" type="number" value="80" step="0.1" />

          <label for="height">Height (cm)</label>
          <input id="height" type="number" value="180" />

          <label for="pal">PAL</label>
          <input id="pal" type="number" value="1.5" step="0.05" />

          <label for="sessions">Sessions / week</label>
          <input id="sessions" type="number" value="3" min="0" max="14" />

          <label for="sessionMin">Session length (min)</label>
          <input id="sessionMin" type="number" value="60" min="20" max="180" />

          <label for="intensity">Intensity</label>
          <select id="intensity">
            <option value="light">Light</option>
            <option value="moderate" selected>Moderate</option>
            <option value="hard">Hard</option>
          </select>

          <label for="dailyAdj">Daily kcal adjustment</label>
          <input id="dailyAdj" type="number" value="-300" step="50" />
        </div>
        <p class="notice">All calories and macros update automatically as you edit inputs.</p>
      </div>

      <div class="card">
        <h2>Energy & macros</h2>
        <div id="energyOutputs">
          <div class="output-row">
            <span>RMR</span>
            <span class="value" id="rmr">-</span>
          </div>
          <div class="output-row">
            <span>Training kcal / day</span>
            <span class="value" id="trainKcal">-</span>
          </div>
          <div class="output-row">
            <span>TDEE</span>
            <span class="value" id="tdee">-</span>
          </div>
          <div class="output-row">
            <span>Target kcal</span>
            <span class="value" id="targetKcal">-</span>
          </div>
          <div class="output-row">
            <span>Δ kg / week (approx)</span>
            <span class="value" id="deltaKg">-</span>
          </div>
        </div>

        <hr style="border-color:#242938;margin:8px 0;" />

        <div id="macroOutputs">
          <div class="output-row">
            <span>Carbs (g)</span>
            <span class="value" id="carbG">-</span>
          </div>
          <div class="output-row">
            <span>Protein (g)</span>
            <span class="value" id="protG">-</span>
          </div>
          <div class="output-row">
            <span>Fat (g)</span>
            <span class="value" id="fatG">-</span>
          </div>
        </div>
        <p class="muted">Macro split defaults to 35% carbs, 35% protein, 30% fat. Adjust in code if needed.[web:141]</p>
      </div>

      <div class="card">
        <h2>Peri‑workout guide</h2>
        <table>
          <thead>
            <tr>
              <th>Phase</th>
              <th>Protein</th>
              <th>Carbs</th>
            </tr>
          </thead>
          <tbody id="periTable">
            <!-- Filled by JS -->
          </tbody>
        </table>
        <p class="notice">Ranges use your client’s body weight and total carbs to stay within evidence‑based targets.[web:73][web:80]</p>
      </div>
    </div>

    <!-- RIGHT COLUMN: NEW MEAL TIMING CARDS -->
    <div>
      <!-- Training Day Card -->
      <div class="card">
        <h2>Training day timing</h2>

        <div class="grid-2">
          <label for="tdWake">Wake time</label>
          <input id="tdWake" type="time" value="07:00" />

          <label for="tdBed">Bed time</label>
          <input id="tdBed" type="time" value="23:00" />

          <label for="tdTrain">Training start</label>
          <input id="tdTrain" type="time" value="18:00" />

          <label for="tdMeals">Meals per day</label>
          <select id="tdMeals">
            <option value="4" selected>4</option>
            <option value="5">5</option>
          </select>
        </div>

        <p class="notice">
          First feeding within 1 h of waking, last 2–3 h before bed, mostly 3–5 h gaps, ≥4 protein feedings to support muscle retention and growth.[web:90][web:110][web:112]
        </p>

        <table>
          <thead>
            <tr>
              <th>Meal</th>
              <th>Time</th>
              <th>Tag</th>
              <th>Protein (g)</th>
              <th>Carbs (g)</th>
              <th>Fat (g)</th>
            </tr>
          </thead>
          <tbody id="tdMealBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>

      <!-- Rest Day Card -->
      <div class="card">
        <h2>Rest day timing</h2>

        <div class="grid-2">
          <label for="rdWake">Wake time</label>
          <input id="rdWake" type="time" value="07:00" />

          <label for="rdBed">Bed time</label>
          <input id="rdBed" type="time" value="23:00" />

          <label for="rdMeals">Meals per day</label>
          <select id="rdMeals">
            <option value="4" selected>4</option>
            <option value="5">5</option>
          </select>
        </div>

        <p class="notice">
          Same spacing rules, same ≥4 protein feedings, just without pre/intra/post tags. Coach can mirror training‑day macros or use lower‑kcal rest‑day targets.[web:90][web:110][web:111]
        </p>

        <table>
          <thead>
            <tr>
              <th>Meal</th>
              <th>Time</th>
              <th>Protein (g)</th>
              <th>Carbs (g)</th>
              <th>Fat (g)</th>
            </tr>
          </thead>
          <tbody id="rdMealBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helper functions ----------
    function parseTimeToMinutes(t) {
      const [h, m] = t.split(":").map(Number);
      return h * 60 + m;
    }
    function minutesToTimeStr(mins) {
      mins = (mins + 1440) % 1440;
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return (h < 10 ? "0" + h : "" + h) + ":" + (m < 10 ? "0" + m : "" + m);
    }

    function getIntensityKcalPerHour(intensity) {
      if (intensity === "light") return 250;
      if (intensity === "hard") return 550;
      return 400; // moderate
    }

    // ---------- Core calculator ----------
    function recalcCore() {
      const gender = document.getElementById("gender").value;
      const age = parseFloat(document.getElementById("age").value) || 0;
      const weight = parseFloat(document.getElementById("weight").value) || 0;
      const height = parseFloat(document.getElementById("height").value) || 0;
      const pal = parseFloat(document.getElementById("pal").value) || 1.3;
      const sessions = parseFloat(document.getElementById("sessions").value) || 0;
      const sessionMin = parseFloat(document.getElementById("sessionMin").value) || 0;
      const intensity = document.getElementById("intensity").value;
      const dailyAdj = parseFloat(document.getElementById("dailyAdj").value) || 0;

      // RMR (Mifflin-St Jeor)
      let rmr;
      if (gender === "M") {
        rmr = 10 * weight + 6.25 * height - 5 * age + 5;
      } else {
        rmr = 10 * weight + 6.25 * height - 5 * age - 161;
      }

      const kcalPerHour = getIntensityKcalPerHour(intensity);
      const trainingKcalPerDay =
        sessions * ((sessionMin * 0.6) / 60) * kcalPerHour / 7;

      const tdee = rmr * pal + trainingKcalPerDay;
      const target = tdee + dailyAdj;
      const deltaKgWeek = dailyAdj * 0.0009;

      document.getElementById("rmr").textContent = Math.round(rmr);
      document.getElementById("trainKcal").textContent = Math.round(trainingKcalPerDay);
      document.getElementById("tdee").textContent = Math.round(tdee);
      document.getElementById("targetKcal").textContent = Math.round(target);
      document.getElementById("deltaKg").textContent = deltaKgWeek.toFixed(2);

      // Macro split: 35/35/30
      const carbKcal = target * 0.35;
      const protKcal = target * 0.35;
      const fatKcal = target * 0.30;

      const carbG = carbKcal / 4;
      const protG = protKcal / 4;
      const fatG = fatKcal / 9;

      document.getElementById("carbG").textContent = Math.round(carbG);
      document.getElementById("protG").textContent = Math.round(protG);
      document.getElementById("fatG").textContent = Math.round(fatG);

      recalcPeri(weight, carbG);
      recalcTrainingDayMeals(weight, protG, carbG, fatG);
      recalcRestDayMeals(weight, protG, carbG, fatG);
    }

    // ---------- Peri-workout table ----------
    function recalcPeri(weight, dailyCarbG) {
      const tbody = document.getElementById("periTable");
      tbody.innerHTML = "";

      // Helper to add rows
      function addRow(phase, pText, cText) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${phase}</td>
          <td>${pText}</td>
          <td>${cText}</td>
        `;
        tbody.appendChild(tr);
      }

      // Pre 1–2 h: 0.4–0.55 g/kg protein, 0.8–1.0 g/kg OR ~15% of carbs
      const preProtLow = Math.round(0.4 * weight);
      const preProtHigh = Math.round(0.55 * weight);
      const preCarbLow = Math.round(Math.min(0.8 * weight, 0.15 * dailyCarbG));
      const preCarbHigh = Math.round(Math.max(1.0 * weight, 0.15 * dailyCarbG));
      addRow(
        "Pre 1–2 h",
        `${preProtLow}–${preProtHigh} g`,
        `${preCarbLow}–${preCarbHigh} g`
      );

      // Pre >2 h: 0.4–0.55 g/kg protein, 0.5–0.8 g/kg OR ~15% carbs
      const pre2CarbLow = Math.round(Math.min(0.5 * weight, 0.15 * dailyCarbG));
      const pre2CarbHigh = Math.round(Math.max(0.8 * weight, 0.15 * dailyCarbG));
      addRow(
        "Pre >2 h",
        `${preProtLow}–${preProtHigh} g`,
        `${pre2CarbLow}–${pre2CarbHigh} g`
      );

      // Intra: typically 0 g protein, 0.5 g/kg or 60 g
      const intraCarbLow = Math.round(Math.min(0.5 * weight, 60));
      const intraCarbHigh = Math.round(Math.max(0.5 * weight, 60));
      addRow("Intra", `Typically 0 g`, `${intraCarbLow}–${intraCarbHigh} g`);

      // Post: 0.6–0.8 g/kg protein, carbs from 0.6–1.5 g/kg or 30% carbs
      const postProtLow = Math.round(0.6 * weight);
      const postProtHigh = Math.round(0.8 * weight);
      const postCarbLow = Math.round(
        Math.min(0.6 * weight, 0.8 * weight, 1.2 * weight, 1.5 * weight, 0.3 * dailyCarbG)
      );
      const postCarbHigh = Math.round(
        Math.max(0.6 * weight, 0.8 * weight, 1.2 * weight, 1.5 * weight, 0.3 * dailyCarbG)
      );
      addRow(
        "Post (≤1 h)",
        `${postProtLow}–${postProtHigh} g`,
        `${postCarbLow}–${postCarbHigh} g`
      );
    }

    // ---------- Meal timing logic (shared helpers) ----------
    function buildMealTimes(wakeStr, bedStr, meals) {
      const wake = parseTimeToMinutes(wakeStr);
      const bed = parseTimeToMinutes(bedStr);
      let awakeSpan = bed - wake;
      if (awakeSpan <= 0) awakeSpan += 1440; // handle wrap
      const firstMeal = wake + 30; // target ~30 min after waking
      const lastMeal = bed - 150; // 2.5 h before bed
      if (lastMeal <= firstMeal) {
        // fallback: pack meals between wake and bed
        const gap = awakeSpan / (meals - 1);
        const times = [];
        for (let i = 0; i < meals; i++) {
          times.push(wake + i * gap);
        }
        return times;
      }
      const span = lastMeal - firstMeal;
      const gap = span / (meals - 1);
      const times = [];
      for (let i = 0; i < meals; i++) {
        times.push(firstMeal + i * gap);
      }
      return times;
    }

    function distributeMacrosOverMeals(meals, protG, carbG, fatG) {
      // Even distribution as a baseline; coaches can tweak after
      const perProt = protG / meals;
      const perCarb = carbG / meals;
      const perFat = fatG / meals;
      const arr = [];
      for (let i = 0; i < meals; i++) {
        arr.push({
          protein: perProt,
          carbs: perCarb,
          fat: perFat
        });
      }
      return arr;
    }

    function tagTrainingMeals(mealTimes, trainStr) {
      const trainMin = parseTimeToMinutes(trainStr);
      const tags = new Array(mealTimes.length).fill("");
      // Find pre: last meal before training
      let preIdx = -1;
      for (let i = 0; i < mealTimes.length; i++) {
        if (mealTimes[i] < trainMin) preIdx = i;
      }
      if (preIdx === -1) preIdx = 0; // if training very early, breakfast becomes pre

      // Find post: first meal after training
      let postIdx = -1;
      for (let i = 0; i < mealTimes.length; i++) {
        if (mealTimes[i] > trainMin) {
          postIdx = i;
          break;
        }
      }
      if (postIdx === -1) postIdx = mealTimes.length - 1; // late training, last meal is post

      tags[preIdx] = "Pre";
      tags[postIdx] = "Post";
      // Intra is at training time (shown in peri card, here just label on pre/post context if wanted)
      return tags;
    }

    // ---------- Training day card ----------
    function recalcTrainingDayMeals(weight, protG, carbG, fatG) {
      const wakeStr = document.getElementById("tdWake").value;
      const bedStr = document.getElementById("tdBed").value;
      const trainStr = document.getElementById("tdTrain").value;
      const meals = parseInt(document.getElementById("tdMeals").value, 10) || 4;

      const times = buildMealTimes(wakeStr, bedStr, meals);
      const macros = distributeMacrosOverMeals(meals, protG, carbG, fatG);
      const tags = tagTrainingMeals(times, trainStr);

      const tbody = document.getElementById("tdMealBody");
      tbody.innerHTML = "";

      times.forEach((t, idx) => {
        const tr = document.createElement("tr");
        const tag = tags[idx];
        const label = `Meal ${idx + 1}`;
        const timeStr = minutesToTimeStr(t);
        const p = Math.round(macros[idx].protein);
        const c = Math.round(macros[idx].carbs);
        const f = Math.round(macros[idx].fat);

        tr.innerHTML = `
          <td>${label}</td>
          <td>${timeStr}</td>
          <td>${tag ? `<span class="tag">${tag}</span>` : ""}</td>
          <td>${p}</td>
          <td>${c}</td>
          <td>${f}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ---------- Rest day card ----------
    function recalcRestDayMeals(weight, protG, carbG, fatG) {
      const wakeStr = document.getElementById("rdWake").value;
      const bedStr = document.getElementById("rdBed").value;
      const meals = parseInt(document.getElementById("rdMeals").value, 10) || 4;

      const times = buildMealTimes(wakeStr, bedStr, meals);
      const macros = distributeMacrosOverMeals(meals, protG, carbG, fatG);

      const tbody = document.getElementById("rdMealBody");
      tbody.innerHTML = "";

      times.forEach((t, idx) => {
        const tr = document.createElement("tr");
        const label = `Meal ${idx + 1}`;
        const timeStr = minutesToTimeStr(t);
        const p = Math.round(macros[idx].protein);
        const c = Math.round(macros[idx].carbs);
        const f = Math.round(macros[idx].fat);

        tr.innerHTML = `
          <td>${label}</td>
          <td>${timeStr}</td>
          <td>${p}</td>
          <td>${c}</td>
          <td>${f}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ---------- Event wiring ----------
    function wireInputs() {
      const ids = [
        "gender","age","weight","height","pal","sessions",
        "sessionMin","intensity","dailyAdj",
        "tdWake","tdBed","tdTrain","tdMeals",
        "rdWake","rdBed","rdMeals"
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("input", recalcCore);
        el.addEventListener("change", recalcCore);
      });
    }

    wireInputs();
    recalcCore();
  </script>
</body>
</html>
